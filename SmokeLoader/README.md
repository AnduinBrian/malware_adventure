# SmokeLoader
> SmokeLoader is primarily a loader, and its main objective is to download or load a stealthier or more effective malware into the system.

#### My impression:
  + Anti-VM, Anti-Sandbox (vmware, vbox,...).
  + Anti-process (procexp64.exe, x32dbg.exe,...).
  + Anti-Debug (PEB ntGlobalFlag).
  + Encrypt String, C2,...
  + Payload Compressed (lsza, lznt1).
  + Obfuscated code.

#### Execute flow:
  + mal.bin -> stage_2.bin -> final_stage.bin

## Variant 1:
  > sha256: [f656bec8181d8911220fbe23c86ad5e80b45b613990707ef8815482135e898ab](https://www.virustotal.com/gui/file/cef4f5f561b5c481c67e0a9a3dd751d18d696b61c7a5dab5ebb29535093741b4)
  - mal.bin:
    - Alloc memory, write shellcode into alloced mem, then execute it.
    - The data in new memory is a PE file, dump it and we will have stage_2.bin
  - stage_2.bin:
    - Load PE into IDA and look at the start func:
      ![image](https://github.com/AnduinBrian/malware_adventure/assets/36282595/2045265f-3825-4afa-a40c-c694487d001c)
    - This is called ["opaque predicate"](https://en.wikipedia.org/wiki/Opaque_predicate). The program will jump to loc_402DE9+1 (you can verify by debug it) everytime, so we will patch it with jmp instruction.
    - [ida_script](https://github.com/AnduinBrian/malware_adventure/blob/SmokeLoader/SmokeLoader/ida_script_universal/ida_script.py#L12) -> patch_nop in this script will find jnz and jz pattern, after that it patch to jmp xxx and nop.
    - Body of function in Smokeloader will be encrypted with xor. It will decrypt the body first, execute it and re-encrypt the body.
    ![image](https://github.com/AnduinBrian/malware_adventure/assets/36282595/80a08f07-fa11-458f-acad-0d15f8c8665e)
    - It resolve API by using djb2_hash, it travel through PEB structre to find handle of dll.
    - Enumerate all subkey of these key (Anti-VM):
      - System\CurrentControlSet\Enum\IDE
      - System\CurrentControlSet\Enum\SCSI
    - Final payload will be stored somewhere in stage_2, after some anti-* func we will some instruction that lead to final_stage location. In this example: final_stage data start at base + 0x53e3 and size is 0x2FDE.
    ![image](https://github.com/AnduinBrian/malware_adventure/assets/36282595/6f455c88-70fc-401f-a3c9-97d7f60c6624)
    - data of final_stage will be xor with const (this time is 0x76186250), after xor we will have a buffer but it compressed, we need to decompress. This sample using lzsa2 to compress and decompress, you can verify it by looking the function after the xor function ([lzsa2](https://www.manhunter.ru/assembler/1593_raspakovka_dannih_v_formate_lzsa1_i_lzsa2_na_assemblere.html)) 
    <br>![image](https://github.com/AnduinBrian/malware_adventure/assets/36282595/d4ef6883-6432-4a30-b697-bdebc8247042)
    - I use unicorn engine to emulate, the script [here](https://github.com/AnduinBrian/malware_adventure/blob/SmokeLoader/SmokeLoader/variant%201/Scripts/ida_uc_emu.py). The function [xor_dword](https://github.com/AnduinBrian/malware_adventure/blob/SmokeLoader/SmokeLoader/ida_script_universal/ida_script.py#L38) in the ida_script will be used for xor function i mention before.
    - First 4 bytes is the length of the compressed data (0x5400).
    - After run emu script. We have a binary, but not in PE format. We just need to fix 3 place:
      - First: edit to hex 4D 5A or text "MZ".
      - Sec: edit to hex C0.
      - Third: edit to hex 50 45 or text "PE". <br>
   ![image](https://github.com/AnduinBrian/malware_adventure/assets/36282595/4fd39aa9-c34f-4e07-b837-fc1e0cbd55df).
  - stage_3:
    - In this stage, we will focus on how to dump config. We just looking for function that have xor (xor use alot in encrypt and decrypt) and find one function look like rc4.
    - Look at the function, we see that the function have 4 param:
      - 1st: data
      - 2nd: key
      - 3rd: data len
      - 4nd: key len (usually = 4) 
    - We will see a call instruction at 0x1800020E6, the param is pointer. After some RE, we will find out:
      ![image](https://github.com/AnduinBrian/malware_adventure/assets/36282595/61a09456-b582-43b1-a7f3-8dd28f9e1fc3)
    - Now go ahead and write script to decrypt. We will have output: ```http://nusurionuy5ff.at/```. Xref the unk_1800011C0 and we will see a table look like c2_table [script](https://github.com/AnduinBrian/malware_adventure/blob/SmokeLoader/SmokeLoader/variant%201/Scripts/extract_conf.py#L29). Result:
    ```
      Python> extract_config(0x180001A90, 0xd)
              http://monsutiur4.com/
              http://nusurionuy5ff.at/
              http://moroitomo4.net/
              http://susuerulianita1.net/
              http://cucumbetuturel4.com/
              http://nunuslushau.com/
              http://linislominyt11.at/
              http://luxulixionus.net/
              http://lilisjjoer44.com/
              http://nikogminut88.at/
              http://limo00ruling.org/
              http://mini55tunul.com/
              http://samnutu11nuli.com/
    ```
    


    

  
